<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vite 命令到 createServer | K.island ✨</title>
    <meta name="description" content="K.'s island">
    <link rel="stylesheet" href="/assets/style.019f39fc.css">
    <link rel="modulepreload" href="/assets/Home.97e88eea.js">
    <link rel="modulepreload" href="/assets/app.de03c35d.js">
    <link rel="modulepreload" href="/assets/knowledge_vite_vitejs.md.fcad588e.lean.js">
    <link rel="modulepreload" href="/assets/app.de03c35d.js">
    <link rel="icon" href="/favicon.ico" sizes="64x64">
    <link rel="apple-touch-icon-precomposed" href="/favicon.ico" sizes="64x64">
    <link rel="msapplication-square64x64logo" href="/favicon.ico" sizes="64x64">
    <meta name="twitter:title" content="vite 命令到 createServer | K.island ✨">
    <meta property="og:title" content="vite 命令到 createServer | K.island ✨">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="K.island ✨, back to home" data-v-675d8756 data-v-4a583abe><!----> K.island ✨</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/" data-v-b8818f8c>Home <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/mood/index" data-v-b8818f8c>Mood <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/knowledge/index" data-v-b8818f8c>Knowledge <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/interview/index" data-v-b8818f8c>Interview <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/algorithm/index" data-v-b8818f8c>Algorithm <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/suressk" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/" data-v-b8818f8c>Home <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/mood/index" data-v-b8818f8c>Mood <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/knowledge/index" data-v-b8818f8c>Knowledge <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/interview/index" data-v-b8818f8c>Interview <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/algorithm/index" data-v-b8818f8c>Algorithm <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/suressk" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><p class="sidebar-link-item">Introduction</p><!----></li><li class="sidebar-link"><p class="sidebar-link-item">Study Note</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/knowledge/study/jsEventLoop">JS EventLoop</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/knowledge/study/promise">Promise</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/knowledge/study/vueNextTick">Vue NextTick</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/knowledge/study/algorithm">Algorithm</a><!----></li></ul></li><li class="sidebar-link"><p class="sidebar-link-item">Vite</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/knowledge/vite/index">Vite 原理简介</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/knowledge/vite/vitejs">从 vite 到 createServer</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/knowledge/vite/resolveConfig">resolveConfig</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/knowledge/vite/esbuild">依赖预构建</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/knowledge/vite/plugin">插件机制</a><!----></li></ul></li><li class="sidebar-link"><p class="sidebar-link-item">React</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/knowledge/react/index">React 笔记文章 - 掘金</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><p>我们知道， <code>package.json</code> 文件的 <code>bin</code> 字段是用来指定要运行的命令及运行命令所要执行的文件</p><p>vite 的配置如下：</p><div class="language-json"><pre><code><span class="token punctuation">{</span>
  <span class="token property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;vite&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bin/vite.js&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>好了，我们知道启动 dev-server 的 <code>vite</code> 命令，实际运行的就是 <code>bin/vite.js</code> 文件，那我们进去看看：</p><ol><li>判断当前目录是否包含 <code>node_modules</code> 目录，若不包含，则需要 <code>source-map</code> 支持</li></ol><div class="language-js"><pre><code><span class="token hashbang comment">#!/usr/bin/env node // 固定格式，用来指定命令运行的环境（node）</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__dirname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;node_modules&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// only available as dev dependency</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;source-map-support&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>检查 <code>process.argv</code> 是否是 <code>debug</code> 模式</li></ol><div class="language-js"><pre><code><span class="token comment">// check debug mode first before requiring the CLI.</span>
<span class="token keyword">const</span> debugIndex <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(?:-d|--debug)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> filterIndex <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(?:-f|--filter)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>debugIndex <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span>debugIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value <span class="token operator">||</span> value<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;-&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> <span class="token string">&#39;vite:*&#39;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// support debugging multiple flags</span>
    <span class="token comment">// with comma-separated list</span>
    value <span class="token operator">=</span> value
      <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vite:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>v<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DEBUG</span> <span class="token operator">=</span> value

  <span class="token keyword">if</span> <span class="token punctuation">(</span>filterIndex <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> filter <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span>filterIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>filter<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;-&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VITE_DEBUG_FILTER</span> <span class="token operator">=</span> filter
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>导入编译后的 <code>cli</code> 脚本</li></ol><div class="language-js"><pre><code><span class="token keyword">const</span> profileIndex <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;--profile&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../dist/node/cli&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果配置了 profile 参数</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>profileIndex <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 截掉 &#39;--profile&#39;</span>
  process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>profileIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> next <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span>profileIndex<span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>next<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;-&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>profileIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 创建会话连接（webkit inspector）</span>
  <span class="token keyword">const</span> inspector <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;inspector&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token punctuation">(</span>global<span class="token punctuation">.</span>__vite_profile_session <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">inspector<span class="token punctuation">.</span>Session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;Profiler.enable&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    session<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;Profiler.start&#39;</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 正常启动</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>进入编译后的 <code>dist/node/cli.js</code>，即 <code>src/node/cli.ts</code></li></ol><div class="language-ts"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> cac <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;cac&#39;</span> <span class="token comment">/* 一个简单且强大的命令行库，比 commander 更轻量 */</span>
<span class="token keyword">import</span> chalk <span class="token keyword">from</span> <span class="token string">&#39;chalk&#39;</span> <span class="token comment">/* 美化控制台日志记录 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> performance <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;perf_hooks&#39;</span> <span class="token comment">/* node.js 收集性能指标的对象 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BuildOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./build&#39;</span> <span class="token comment">/* 打包 📦 配置项 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./server&#39;</span> <span class="token comment">/* 启动服务的配置项 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createLogger<span class="token punctuation">,</span> LogLevel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./logger&#39;</span> <span class="token comment">/* 打印日志 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> resolveConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;.&#39;</span> <span class="token comment">/* 处理配置项的方法 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> preview <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./preview&#39;</span> <span class="token comment">/* 打包结果预览方法 */</span>

<span class="token comment">// 使用 cac 生成 cli 实例</span>
<span class="token keyword">const</span> cli <span class="token operator">=</span> <span class="token function">cac</span><span class="token punctuation">(</span><span class="token string">&#39;vite&#39;</span><span class="token punctuation">)</span>
</code></pre></div><ol start="5"><li>全局 cli 选项及清理选项</li></ol><div class="language-ts"><pre><code><span class="token comment">// global options</span>
<span class="token keyword">interface</span> <span class="token class-name">GlobalCLIOptions</span> <span class="token punctuation">{</span>
  <span class="token string">&#39;--&#39;</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  c<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token builtin">string</span>
  config<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  base<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  l<span class="token operator">?</span><span class="token operator">:</span> LogLevel
  logLevel<span class="token operator">?</span><span class="token operator">:</span> LogLevel
  clearScreen<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  d<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token builtin">string</span>
  debug<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token builtin">string</span>
  f<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  filter<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  m<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  mode<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * removing global flags before passing
 * as command specific sub-configs
 * 删除全局 cli 配置
 */</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">cleanOptions</span><span class="token generic class-name"><span class="token operator">&lt;</span>Options <span class="token keyword">extends</span> GlobalCLIOptions<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  options<span class="token operator">:</span> Options<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Omit<span class="token operator">&lt;</span>Options<span class="token punctuation">,</span> <span class="token keyword">keyof</span> GlobalCLIOptions<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>options <span class="token punctuation">}</span>
  <span class="token keyword">delete</span> ret<span class="token punctuation">[</span><span class="token string">&#39;--&#39;</span><span class="token punctuation">]</span>
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>c
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>config
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>base
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>l
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>logLevel
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>clearScreen
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>d
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>debug
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>f
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>filter
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>m
  <span class="token keyword">delete</span> ret<span class="token punctuation">.</span>mode
  <span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
</code></pre></div><ol start="6"><li>cli 参数定义，这里我们就只研究一下开发环境下的功能实现，生产环境/预览环境后续再考虑吧～</li></ol><div class="language-ts"><pre><code><span class="token comment">// 下面是一些核心参数，如 -c 指定配置文件等</span>
cli
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;-c, --config &lt;file&gt;&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[string] use specified config file</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;--base &lt;path&gt;&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[string] public base path (default: /)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;-l, --logLevel &lt;level&gt;&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[string] info | warn | error | silent</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;--clearScreen&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[boolean] allow/disable clear screen when logging</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;-d, --debug [feat]&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[string | boolean] show debug logs</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;-f, --filter &lt;filter&gt;&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[string] filter debug logs</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;-m, --mode &lt;mode&gt;&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[string] set env mode</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

<span class="token comment">// dev 开发环境，主要针对 server 的参数配置</span>
cli
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">&#39;[root]&#39;</span><span class="token punctuation">)</span> <span class="token comment">// default command</span>
  <span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token string">&#39;serve&#39;</span><span class="token punctuation">)</span> <span class="token comment">// the command is called &#39;serve&#39; in Vite&#39;s API</span>
  <span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token string">&#39;dev&#39;</span><span class="token punctuation">)</span> <span class="token comment">// alias to align with the script name</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;--host [host]&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[string] specify hostname</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;--port &lt;port&gt;&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[number] specify port</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;--https&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[boolean] use TLS + HTTP/2</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;--open [path]&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[boolean | string] open browser on startup</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;--cors&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[boolean] enable CORS</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&#39;--strictPort&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[boolean] exit if specified port is already in use</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span>
    <span class="token string">&#39;--force&#39;</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[boolean] force the optimizer to ignore the cache and re-bundle</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span>devAction<span class="token punctuation">)</span>
<span class="token comment">/* 这里将 action 函数抽出来单独看，免得篇幅过长，拎不清注意点 */</span>

cli<span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 命令行使用 -h / --help 参数，输出帮助信息</span>
cli<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&#39;../../package.json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">)</span> <span class="token comment">// vite 版本号</span>

cli<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 解析命令行参数</span>
</code></pre></div><p><code>devAction 函数</code> ：</p><div class="language-ts"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">devAction</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
  root<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> ServerOptions <span class="token operator">&amp;</span> GlobalCLIOptions<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// output structure is preserved even after bundling so require()</span>
  <span class="token comment">// is ok here</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> createServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;./server&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 导入创建 dev-server</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      root<span class="token punctuation">,</span>
      base<span class="token operator">:</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span>
      mode<span class="token operator">:</span> options<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
      configFile<span class="token operator">:</span> options<span class="token punctuation">.</span>config<span class="token punctuation">,</span>
      logLevel<span class="token operator">:</span> options<span class="token punctuation">.</span>logLevel<span class="token punctuation">,</span>
      clearScreen<span class="token operator">:</span> options<span class="token punctuation">.</span>clearScreen<span class="token punctuation">,</span>
      server<span class="token operator">:</span> <span class="token function">cleanOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// native Node http server instance or null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>httpServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;HTTP server not available&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 启动 dev-server</span>
    <span class="token keyword">const</span> info <span class="token operator">=</span> server<span class="token punctuation">.</span>config<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info <span class="token comment">// info 日志</span>

    <span class="token function">info</span><span class="token punctuation">(</span>
      chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  vite v</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&#39;vite/package.json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token operator">+</span>
        chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> dev server running at:\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        clear<span class="token operator">:</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>config<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>hasWarned<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 调用 logger.ts 的 printCommonServerUrls 方法打印 dev-server 运行的 url</span>
    server<span class="token punctuation">.</span><span class="token function">printUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// __vite_start_time 在执行 vite 命令时</span>
    <span class="token comment">// 赋值为 performance.now()，记录启动服务的开始时间</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>global<span class="token punctuation">.</span>__vite_start_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 服务启动时间（ms）</span>
      <span class="token keyword">const</span> startupDuration <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> global<span class="token punctuation">.</span>__vite_start_time
      <span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ready in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>startupDuration<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 打印服务启动失败的日志</span>
    <span class="token function">createLogger</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>logLevel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
      chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">error when starting dev server:\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>stack<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> error<span class="token operator">:</span> e <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 结束进程</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="7"><li>接下来，我们进入 server 模块，查看 <code>createServer</code>：</li></ol><div class="language-ts"><pre><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span>
  inlineConfig<span class="token operator">:</span> InlineConfig <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ViteDevServer<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这个方法里，大概做了下面这些事：</span>
  <span class="token comment">// 1. 处理服务的启动配置</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolveConfig</span><span class="token punctuation">(</span>inlineConfig<span class="token punctuation">,</span> <span class="token string">&#39;serve&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;development&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> httpsOptions <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolveHttpsConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>https<span class="token punctuation">)</span>

  <span class="token comment">// 2. 检查 config.server.middlewareMode 是否 === true，若是将其置为 &#39;ssr&#39;</span>
  <span class="token comment">// connect 包创建连接（方便使用中间件来扩展的 node http server 框架）</span>
  <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Connect<span class="token punctuation">.</span>Server
  <span class="token keyword">const</span> httpServer <span class="token operator">=</span> middlewareMode
    <span class="token operator">?</span> <span class="token keyword">null</span>
    <span class="token operator">:</span> <span class="token keyword">await</span> <span class="token function">resolveHttpServer</span><span class="token punctuation">(</span>serverConfig<span class="token punctuation">,</span> middlewares<span class="token punctuation">,</span> httpsOptions<span class="token punctuation">)</span>
  <span class="token comment">// resolveHttpServer 方法用来区分使用 http / https / http2 (npm package)来</span>
  <span class="token comment">// 创建 server 并返回赋值给 httpServer</span>

  <span class="token comment">// 3. 创建 webSocket 实例</span>
  <span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token function">createWebSocketServer</span><span class="token punctuation">(</span>httpServer<span class="token punctuation">,</span> config<span class="token punctuation">,</span> httpsOptions<span class="token punctuation">)</span>

  <span class="token comment">// 4. 使用 chokidar 监听 文件 修改</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> ignored <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>watchOptions <span class="token punctuation">}</span> <span class="token operator">=</span> serverConfig<span class="token punctuation">.</span>watch <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">const</span> watcher <span class="token operator">=</span> chokidar<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    ignored<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&#39;**/node_modules/**&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;**/.git/**&#39;</span><span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>ignored<span class="token punctuation">)</span> <span class="token operator">?</span> ignored <span class="token operator">:</span> <span class="token punctuation">[</span>ignored<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    ignoreInitial<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    ignorePermissionErrors<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    disableGlobbing<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>watchOptions<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> FSWatcher

  <span class="token comment">// 5. 创建 pluginContainer，创建模块映射表</span>
  <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createPluginContainer</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> moduleGraph<span class="token punctuation">,</span> watcher<span class="token punctuation">)</span>

  <span class="token keyword">const</span> moduleGraph<span class="token operator">:</span> ModuleGraph <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleGraph</span><span class="token punctuation">(</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    container<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> closeHttpServer <span class="token operator">=</span> <span class="token function">createServerCloseFn</span><span class="token punctuation">(</span>httpServer<span class="token punctuation">)</span>

  <span class="token comment">// 6. 创建 server 对象</span>
  <span class="token keyword">const</span> server<span class="token operator">:</span> ViteServer <span class="token operator">=</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">,</span>
    middlewares<span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 过期的 api</span>
      <span class="token keyword">return</span> middlewares
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    httpServer<span class="token punctuation">,</span>
    watcher<span class="token punctuation">,</span>
    pluginContainer<span class="token operator">:</span> container<span class="token punctuation">,</span>
    ws<span class="token punctuation">,</span>
    moduleGraph<span class="token punctuation">,</span>
    transformWithEsbuild<span class="token punctuation">,</span>
    <span class="token function">transformRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> server<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    transformIndexHtml<span class="token operator">:</span> <span class="token keyword">null</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token comment">// to be immediately set</span>
    <span class="token function">ssrLoadModule</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ... 服务端渲染加载 module</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> isRestart<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 启动 dev-server 方法</span>
      <span class="token keyword">return</span> <span class="token function">startServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> port<span class="token punctuation">,</span> isRestart<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 退出 dev-server</span>
      <span class="token comment">// watcher，ws，container，httpServer</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">printUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 打印日志</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">restart</span><span class="token punctuation">(</span>forceOptimize<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用 restartServer 方法，重启 dev-server</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// _xxxx  一些私有属性</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 立即创建转换 html 的方法</span>
  server<span class="token punctuation">.</span>transformIndexHtml <span class="token operator">=</span> <span class="token function">createDevHtmlTransformFn</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>

  <span class="token comment">// 7. package 缓存</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> packageCache <span class="token punctuation">}</span> <span class="token operator">=</span> config
  <span class="token keyword">const</span> setPackageData <span class="token operator">=</span> packageCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>packageCache<span class="token punctuation">)</span>
  packageCache<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;.json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      watcher<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">setPackageData</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 8. watcher 监听文件变化：change, add, unlink</span>
  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;change&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 格式化文件路径</span>
    file <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token comment">// 若是 package.json 文件变化，校验依赖是否变更</span>
    <span class="token comment">// 删除 packageCache 中的缓存记录</span>

    <span class="token comment">// 若是其他文件变更，更新 moduleGraph</span>
    <span class="token comment">// 判断是否开启 hmr（默认开启）</span>
    <span class="token comment">// handleHMRUpdate(file, server) 触发热更新</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;add&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">handleFileAddUnlink</span><span class="token punctuation">(</span><span class="token function">normalizePath</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> server<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;unlink&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">handleFileAddUnlink</span><span class="token punctuation">(</span><span class="token function">normalizePath</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> server<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 9. 一堆中间件的应用</span>
  <span class="token comment">// /node/server/middlewares/*.ts</span>

  <span class="token keyword">return</span> server <span class="token comment">// 返回创建的 server 对象</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><a class="link" href="https://github.com/suressk/edit/deploy/docs/knowledge/vite/vitejs.md" target="_blank" rel="noopener noreferrer" data-v-1ed99556>Edit this page on GitHub <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-1ed99556><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-fb8d84c6><p class="last-updated" data-v-fb8d84c6 data-v-5797b537><span class="prefix" data-v-5797b537>Last Updated:</span><span class="datetime" data-v-5797b537></span></p></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/knowledge/vite/" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>Vite 原理简介</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/knowledge/vite/resolveConfig" data-v-38ede35f><span class="text" data-v-38ede35f>resolveConfig</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"algorithm_index.md\":\"995483c0\",\"algorithm_summary_complexity.md\":\"05598d50\",\"index.md\":\"a4c9e401\",\"interview_index.md\":\"487e5ec4\",\"interview_summary_actual.md\":\"60c5b8c5\",\"interview_summary_index.md\":\"e79b7f58\",\"interview_summary_optimization.md\":\"ab7796ac\",\"interview_summary_strands.md\":\"c7129cbc\",\"knowledge_index.md\":\"f96c7886\",\"knowledge_react_index.md\":\"9a946ced\",\"knowledge_study_algorithm.md\":\"ab275a6a\",\"knowledge_study_jseventloop.md\":\"58a54537\",\"knowledge_study_promise.md\":\"8bd006cf\",\"knowledge_study_vuenexttick.md\":\"77bcbe81\",\"knowledge_vite_esbuild.md\":\"fc7315fa\",\"knowledge_vite_index.md\":\"c6cbcbc8\",\"knowledge_vite_plugin.md\":\"f58be03f\",\"knowledge_vite_resolveconfig.md\":\"c73d426a\",\"knowledge_vite_vitejs.md\":\"fcad588e\",\"mood_autumn.md\":\"8a0cd039\",\"mood_chinaintheclassics.md\":\"19077288\",\"mood_christmas.md\":\"34d2eedb\",\"mood_dragonboatfestival.md\":\"f4943cad\",\"mood_feels.md\":\"4851e5e5\",\"mood_index.md\":\"5ff2cc76\",\"mood_loneliness.md\":\"282c46fe\",\"mood_spring.md\":\"29070bca\",\"mood_wind.md\":\"cd9c9555\",\"mood_yearend.md\":\"35604544\"}")</script>
    <script type="module" async src="/assets/app.de03c35d.js"></script>
    
  </body>
</html>